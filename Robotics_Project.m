clc
clear all

%% Defining parameters
syms d3 d5 theta_1 theta_2 theta_3 theta_4 theta_5 theta_6 theta_7

%% Hemogeneous Transformations using modified D-H parameters
T1 = Transform (0 , 0 , 0, theta_1);

T2 = Transform (0, pi/2 ,0, theta_2);
T2(2,1) = 0;
T2(2,2) = 0;
T2(3,3) = 0;

T3 = Transform (0 , -pi/2 , d3, theta_3);
T3(2,1) = 0;
T3(2,2) = 0;
T3(3,3) = 0;
T3(3,4) = 0;

T4 = Transform (0 , -pi/2 , 0, theta_4);
T4(2,1) = 0;
T4(2,2) = 0;
T4(3,3) = 0;

T5 = Transform (0 , pi/2 , d5, theta_5);
T5(2,1) = 0;
T5(2,2) = 0;
T5(3,3) = 0;
T5(3,4) = 0;

T6 = Transform (0 , pi/2 , 0, theta_6);
T6(2,1) = 0;
T6(2,2) = 0;
T6(3,3) = 0;

T7 = Transform (0 , -pi/2 , 0, theta_7);
T7(2,1) = 0;
T7(2,2) = 0;
T7(3,3) = 0;

%% Forward Kinematics of robot
result = T1*T2*T3*T4*T5*T6*T7;
EE_Position = result(1:3,4);

%% Jacobian matrix

mul2=T1*T2;
mul3=T1*T2*T3;
mul4=T1*T2*T3*T4;
mul5=T1*T2*T3*T4*T5;
mul6=T1*T2*T3*T4*T5*T6;
mul7=T1*T2*T3*T4*T5*T6*T7;

z1=T1(1:3,3);
z2=mul2(1:3,3);
z3=mul3(1:3,3);
z4=mul4(1:3,3);
z5=mul5(1:3,3);
z6=mul6(1:3,3);
z7=mul7(1:3,3);

j11 = diff(mul7(1,4),theta_1);
j12 = diff(mul7(1,4),theta_2);
j13 = diff(mul7(1,4),theta_3);
j14 = diff(mul7(1,4),theta_4);
j15 = diff(mul7(1,4),theta_5);
j16 = diff(mul7(1,4),theta_6);
j17 = diff(mul7(1,4),theta_7);

j21 = diff(mul7(2,4),theta_1);
j22 = diff(mul7(2,4),theta_2);
j23 = diff(mul7(2,4),theta_3);
j24 = diff(mul7(2,4),theta_4);
j25 = diff(mul7(2,4),theta_5);
j26 = diff(mul7(2,4),theta_6);
j27 = diff(mul7(2,4),theta_7);

j31 = diff(mul7(3,4),theta_1);
j32 = diff(mul7(3,4),theta_2);
j33 = diff(mul7(3,4),theta_3);
j34 = diff(mul7(3,4),theta_4);
j35 = diff(mul7(3,4),theta_5);
j36 = diff(mul7(3,4),theta_6);
j37 = diff(mul7(3,4),theta_7);

jv1 = [j11,j12,j13,j14,j15,j16,j17];
jv2 = [j21,j22,j23,j24,j25,j26,j27];
jv3 = [j31,j32,j33,j34,j35,j36,j37];

Jv = [jv1;jv2;jv3];
Jw = [z1,z2,z3,z4,z5,z6,z7];

% 6*7 jacobian matrix of robot
Jacob = [Jv;Jw];

% 6*7 time derivative of jacobian matrix of robot
syms theta_1_dot theta_2_dot theta_3_dot theta_4_dot theta_5_dot theta_6_dot theta_7_dot

Jacob_dot = diff(Jacob,theta_1)*theta_1_dot + diff(Jacob,theta_2)*theta_2_dot + diff(Jacob,theta_3)*theta_3_dot + diff(Jacob,theta_4)*theta_4_dot + diff(Jacob,theta_5)*theta_5_dot + diff(Jacob,theta_6)*theta_6_dot+diff(Jacob,theta_7)*theta_7_dot;

%% Inverse Kinematics of robot

L1 = Link('d', 0, 'a', 0, 'alpha', pi/2);
L2 = Link('d', 0, 'a', 0, 'alpha', -pi/2);
L3 = Link('d', 0.4, 'a', 0, 'alpha', -pi/2);
L4 = Link('d', 0, 'a', 0, 'alpha', pi/2);
L5 = Link('d', 0.39, 'a', 0, 'alpha', pi/2);
L6 = Link('d', 0, 'a', 0, 'alpha', -pi/2);
L7 = Link('d', 0, 'a', 0, 'alpha', 0);
bot = SerialLink([L1 L2 L3 L4 L5 L6 L7], 'name', 'my robot');

q = [pi/2 0 -pi/4 0 0 pi/2 pi/8]

T = bot.fkine(q)

qi = bot.ikine(T)

TI = bot.fkine(qi)


%% Manipulator Workspace

d3=0.4;d5=0.39;

% joint angle constraints
cons1=linspace(-170,170,8)*pi/180;
cons2=linspace(-120,120,8)*pi/180;
cons3=linspace(-170,170,8)*pi/180;
cons4=linspace(-120,120,8)*pi/180;
cons5=linspace(-170,170,8)*pi/180;
cons6=linspace(-120,120,8)*pi/180;
cons7=linspace(-175,175,8)*pi/180;

% plot 3D workspace
[theta_1, theta_2, theta_3, theta_4, theta_5, theta_6, theta_7]=ndgrid(cons1,cons2,cons3,cons4,cons5,cons6,cons7);
xM = - d5.*(sin(theta_4).*(sin(theta_1).*sin(theta_3) - cos(theta_1).*cos(theta_2).*cos(theta_3)) + cos(theta_1).*cos(theta_4).*sin(theta_2)) - d3.*cos(theta_1).*sin(theta_2); 
yM = d5.*(sin(theta_4).*(cos(theta_1).*sin(theta_3) + cos(theta_2).*cos(theta_3).*sin(theta_1)) - cos(theta_4).*sin(theta_1).*sin(theta_2)) - d3.*sin(theta_1).*sin(theta_2);
zM = d5.*(cos(theta_2).*cos(theta_4) + cos(theta_3).*sin(theta_2).*sin(theta_4)) + d3.*cos(theta_2);
figure(2)
plot3(xM(:),yM(:),zM(:),'.')

%% RVC
L1 = Link('d', 0, 'a', 0, 'alpha', pi/2);
L2 = Link('d', 0, 'a', 0, 'alpha', -pi/2);
L3 = Link('d', 0.4, 'a', 0, 'alpha', -pi/2);
L4 = Link('d', 0, 'a', 0, 'alpha', pi/2);
L5 = Link('d', 0.39, 'a', 0, 'alpha', pi/2);
L6 = Link('d', 0, 'a', 0, 'alpha', -pi/2);
L7 = Link('d', 0, 'a', 0, 'alpha', 0);
bot = SerialLink([L1 L2 L3 L4 L5 L6 L7], 'name', 'KUKA LWR4+');

T1 = transl(-0.2, 0.4, 0.2); % define the start point
T2 = transl(0.4, -0.3, 0.5);	% and destination
T = ctraj(T1, T2, 100); 	% compute a Cartesian path

q = bot.ikine(T); 
about q

% Plot joint angles
figure(3)
subplot(4,2,1); plot(q(:,1)); xlabel('Time (s)'); ylabel('Joint 1 (rad)');
subplot(4,2,2); plot(q(:,2)); xlabel('Time (s)'); ylabel('Joint 2 (rad)');
subplot(4,2,3); plot(q(:,3)); xlabel('Time (s)'); ylabel('Joint 3 (rad)');
subplot(4,2,4); plot(q(:,4)); xlabel('Time (s)'); ylabel('Joint 4 (rad)');
subplot(4,2,5); plot(q(:,5)); xlabel('Time (s)'); ylabel('Joint 5 (rad)');
subplot(4,2,6); plot(q(:,6)); xlabel('Time (s)'); ylabel('Joint 6 (rad)');
subplot(4,2,7); plot(q(:,7)); xlabel('Time (s)'); ylabel('Joint 7 (rad)');

% Animating robot trajectory
figure(4)
clf; 
bot.plot(q);

% bot.plot([1.1 1.2 0.3 1.4 1.5 1.6 1.7]);

%% Dynamic model of robot

% Defining parameters
syms t1 t2 t3 t4...
     td1 td2 td3 td4...
     tdd1 tdd2 tdd3 tdd4 ...
     s1 s2 s3 s4...
     c1 c2 c3 c4...
     Ixy1 Ixz1 Iyz1 Ixx1 Iyy1 Izz1...
     Ixy2 Ixz2 Iyz2 Ixx2 Iyy2 Izz2...
     Ixy3 Ixz3 Iyz3 Ixx3 Iyy3 Izz3...
     Ixy4 Ixz4 Iyz4 Ixx4 Iyy4 Izz4...
     m1 m2 m3 m4...
     cx1 cx2 cx3 cx4...
     cy1 cy2 cy3 cy4...
     cz1 cz2 cz3 cz4...
     g...
     d1 d2 d3 d4 ...
    
% Link 1
% str1 = "[-Ixz2*(c2*td1*td2 + s2*tdd1) - Iyz2*(c2*tdd1 - s2*td1*td2) + Izz1*tdd1 + Izz2*tdd2 - c2*td1*(Ixx2*s2*td1 - Ixy2*c2*td1 - Ixz2*td2) + c2*(-Ixy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Ixz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - Iyz3*(c2*tdd1 - s2*td1*td2 + tdd3) - Iyz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + Izz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx3*m3*(c2*g - cx3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + cy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - (-c3*td2 - s2*s3*td1)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) + (cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) + cx4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) - cy4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) + cz3*m3*(c3*g*s2 - cy3*(c2*tdd1 - s2*td1*td2 + tdd3) + cz3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - (c2*td1 + td3)*(cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2)) + (-c3*td2 - s2*s3*td1)*(-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))) + d3*(c3*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - m4*s3*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4))) + (c2*td1 + td3)*(Ixx3*(c3*s2*td1 - s3*td2) - Ixy3*(-c3*td2 - s2*s3*td1) - Ixz3*(c2*td1 + td3)) - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4)) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4)) - (c3*s2*td1 - s3*td2)*(-Ixz3*(c3*s2*td1 - s3*td2) - Iyz3*(-c3*td2 - s2*s3*td1) + Izz3*(c2*td1 + td3))) + cx1*m1*(cx1*tdd1 - cy1*td1**2) + cx2*m2*(c2*g + cx2*tdd2 - cz2*(c2*td1*td2 + s2*tdd1) - s2*td1*(-c2*cx2*td1 + cy2*s2*td1) + td2*(c2*cz2*td1 - cy2*td2)) - cy1*m1*(-cx1*td1**2 - cy1*tdd1) - cy2*m2*(c2*td1*(-c2*cx2*td1 + cy2*s2*td1) - cy2*tdd2 + cz2*(c2*tdd1 - s2*td1*td2) + g*s2 - td2*(cx2*td2 - cz2*s2*td1)) + s2*td1*(-Ixy2*s2*td1 + Iyy2*c2*td1 - Iyz2*td2) + s2*(Ixx3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Ixy3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - Ixz3*(c2*tdd1 - s2*td1*td2 + tdd3) + c3*(Ixx4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - Ixy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Ixz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cy4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - cz4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) - (-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) + cy3*m3*(c2*g - cx3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + cy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - (-c3*td2 - s2*s3*td1)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) + (cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - cz3*m3*(cx3*(c2*tdd1 - s2*td1*td2 + tdd3) - cz3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 + (c2*td1 + td3)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) - (-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - d3*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - s3*(-Ixy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Iyz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) + cz4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) + (Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) - (c2*td1 + td3)*(-Ixy3*(c3*s2*td1 - s3*td2) + Iyy3*(-c3*td2 - s2*s3*td1) - Iyz3*(c2*td1 + td3)) + (-c3*td2 - s2*s3*td1)*(-Ixz3*(c3*s2*td1 - s3*td2) - Iyz3*(-c3*td2 - s2*s3*td1) + Izz3*(c2*td1 + td3)))]"
% newStr1 = replace(str1,"**2","^2")

a1 = -Ixz2*(c2*td1*td2 + s2*tdd1) - Iyz2*(c2*tdd1 - s2*td1*td2) + Izz1*tdd1 + Izz2*tdd2 - c2*td1*(Ixx2*s2*td1 - Ixy2*c2*td1 - Ixz2*td2) + c2*(-Ixy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Ixz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - Iyz3*(c2*tdd1 - s2*td1*td2 + tdd3) - Iyz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + Izz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx3*m3*(c2*g - cx3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + cy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - (-c3*td2 - s2*s3*td1)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) + (cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) + cx4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) - cy4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) + cz3*m3*(c3*g*s2 - cy3*(c2*tdd1 - s2*td1*td2 + tdd3) + cz3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - (c2*td1 + td3)*(cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2)) + (-c3*td2 - s2*s3*td1)*(-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))) + d3*(c3*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - m4*s3*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4))) + (c2*td1 + td3)*(Ixx3*(c3*s2*td1 - s3*td2) - Ixy3*(-c3*td2 - s2*s3*td1) - Ixz3*(c2*td1 + td3)) - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4)) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4)) - (c3*s2*td1 - s3*td2)*(-Ixz3*(c3*s2*td1 - s3*td2) - Iyz3*(-c3*td2 - s2*s3*td1) + Izz3*(c2*td1 + td3))) + cx1*m1*(cx1*tdd1 - cy1*td1^2) + cx2*m2*(c2*g + cx2*tdd2 - cz2*(c2*td1*td2 + s2*tdd1) - s2*td1*(-c2*cx2*td1 + cy2*s2*td1) + td2*(c2*cz2*td1 - cy2*td2)) - cy1*m1*(-cx1*td1^2 - cy1*tdd1) - cy2*m2*(c2*td1*(-c2*cx2*td1 + cy2*s2*td1) - cy2*tdd2 + cz2*(c2*tdd1 - s2*td1*td2) + g*s2 - td2*(cx2*td2 - cz2*s2*td1)) + s2*td1*(-Ixy2*s2*td1 + Iyy2*c2*td1 - Iyz2*td2) + s2*(Ixx3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Ixy3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - Ixz3*(c2*tdd1 - s2*td1*td2 + tdd3) + c3*(Ixx4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - Ixy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Ixz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cy4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - cz4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) - (-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) + cy3*m3*(c2*g - cx3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + cy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - (-c3*td2 - s2*s3*td1)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) + (cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - cz3*m3*(cx3*(c2*tdd1 - s2*td1*td2 + tdd3) - cz3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 + (c2*td1 + td3)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) - (-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - d3*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - s3*(-Ixy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Iyz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) + cz4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) + (Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) - (c2*td1 + td3)*(-Ixy3*(c3*s2*td1 - s3*td2) + Iyy3*(-c3*td2 - s2*s3*td1) - Iyz3*(c2*td1 + td3)) + (-c3*td2 - s2*s3*td1)*(-Ixz3*(c3*s2*td1 - s3*td2) - Iyz3*(-c3*td2 - s2*s3*td1) + Izz3*(c2*td1 + td3)));

m11 = diff(a1,tdd1);
m12 = diff(a1,tdd2);
m13 = diff(a1,tdd3);
m14 = diff(a1,tdd4);

corio1=(td1*td1*diff(a1,td1,td1) + td1*td2*diff(a1,td1,td2) + td1*td3*diff(a1,td1,td3) + td1*td4*diff(a1,td1,td4)+...
        td2*td1*diff(a1,td2,td1) + td2*td2*diff(a1,td2,td2) + td2*td3*diff(a1,td2,td3) + td2*td4*diff(a1,td2,td4)+...
        td3*td1*diff(a1,td3,td1) + td3*td2*diff(a1,td3,td2) + td3*td3*diff(a1,td3,td3) + td3*td4*diff(a1,td3,td4)+...
        td4*td1*diff(a1,td4,td1) + td4*td2*diff(a1,td4,td2) + td4*td3*diff(a1,td4,td3) + td4*td4*diff(a1,td4,td4))/2;

ds_1g = diff(a1,g);
g1 =  ds_1g * g;

% Link 2    
% str2 = "[-Ixz2*(c2*td1*td2 + s2*tdd1) - Iyz2*(c2*tdd1 - s2*td1*td2) + Izz2*tdd2 - c2*td1*(Ixx2*s2*td1 - Ixy2*c2*td1 - Ixz2*td2) + c2*(-Ixy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Ixz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - Iyz3*(c2*tdd1 - s2*td1*td2 + tdd3) - Iyz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + Izz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx3*m3*(c2*g - cx3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + cy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - (-c3*td2 - s2*s3*td1)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) + (cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) + cx4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) - cy4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) + cz3*m3*(c3*g*s2 - cy3*(c2*tdd1 - s2*td1*td2 + tdd3) + cz3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - (c2*td1 + td3)*(cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2)) + (-c3*td2 - s2*s3*td1)*(-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))) + d3*(c3*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - m4*s3*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4))) + (c2*td1 + td3)*(Ixx3*(c3*s2*td1 - s3*td2) - Ixy3*(-c3*td2 - s2*s3*td1) - Ixz3*(c2*td1 + td3)) - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4)) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4)) - (c3*s2*td1 - s3*td2)*(-Ixz3*(c3*s2*td1 - s3*td2) - Iyz3*(-c3*td2 - s2*s3*td1) + Izz3*(c2*td1 + td3))) + cx2*m2*(c2*g + cx2*tdd2 - cz2*(c2*td1*td2 + s2*tdd1) - s2*td1*(-c2*cx2*td1 + cy2*s2*td1) + td2*(c2*cz2*td1 - cy2*td2)) - cy2*m2*(c2*td1*(-c2*cx2*td1 + cy2*s2*td1) - cy2*tdd2 + cz2*(c2*tdd1 - s2*td1*td2) + g*s2 - td2*(cx2*td2 - cz2*s2*td1)) + s2*td1*(-Ixy2*s2*td1 + Iyy2*c2*td1 - Iyz2*td2) + s2*(Ixx3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Ixy3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - Ixz3*(c2*tdd1 - s2*td1*td2 + tdd3) + c3*(Ixx4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - Ixy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Ixz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cy4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - cz4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) - (-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) + cy3*m3*(c2*g - cx3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + cy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - (-c3*td2 - s2*s3*td1)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) + (cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - cz3*m3*(cx3*(c2*tdd1 - s2*td1*td2 + tdd3) - cz3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 + (c2*td1 + td3)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) - (-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - d3*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - s3*(-Ixy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Iyz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) + cz4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) + (Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) - (c2*td1 + td3)*(-Ixy3*(c3*s2*td1 - s3*td2) + Iyy3*(-c3*td2 - s2*s3*td1) - Iyz3*(c2*td1 + td3)) + (-c3*td2 - s2*s3*td1)*(-Ixz3*(c3*s2*td1 - s3*td2) - Iyz3*(-c3*td2 - s2*s3*td1) + Izz3*(c2*td1 + td3)))]"
% newStr2 = replace(str2,"**2","^2")

a2 = -Ixz2*(c2*td1*td2 + s2*tdd1) - Iyz2*(c2*tdd1 - s2*td1*td2) + Izz2*tdd2 - c2*td1*(Ixx2*s2*td1 - Ixy2*c2*td1 - Ixz2*td2) + c2*(-Ixy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Ixz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - Iyz3*(c2*tdd1 - s2*td1*td2 + tdd3) - Iyz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + Izz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx3*m3*(c2*g - cx3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + cy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - (-c3*td2 - s2*s3*td1)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) + (cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) + cx4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) - cy4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) + cz3*m3*(c3*g*s2 - cy3*(c2*tdd1 - s2*td1*td2 + tdd3) + cz3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - (c2*td1 + td3)*(cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2)) + (-c3*td2 - s2*s3*td1)*(-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))) + d3*(c3*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - m4*s3*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4))) + (c2*td1 + td3)*(Ixx3*(c3*s2*td1 - s3*td2) - Ixy3*(-c3*td2 - s2*s3*td1) - Ixz3*(c2*td1 + td3)) - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4)) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4)) - (c3*s2*td1 - s3*td2)*(-Ixz3*(c3*s2*td1 - s3*td2) - Iyz3*(-c3*td2 - s2*s3*td1) + Izz3*(c2*td1 + td3))) + cx2*m2*(c2*g + cx2*tdd2 - cz2*(c2*td1*td2 + s2*tdd1) - s2*td1*(-c2*cx2*td1 + cy2*s2*td1) + td2*(c2*cz2*td1 - cy2*td2)) - cy2*m2*(c2*td1*(-c2*cx2*td1 + cy2*s2*td1) - cy2*tdd2 + cz2*(c2*tdd1 - s2*td1*td2) + g*s2 - td2*(cx2*td2 - cz2*s2*td1)) + s2*td1*(-Ixy2*s2*td1 + Iyy2*c2*td1 - Iyz2*td2) + s2*(Ixx3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Ixy3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - Ixz3*(c2*tdd1 - s2*td1*td2 + tdd3) + c3*(Ixx4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - Ixy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Ixz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cy4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - cz4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) - (-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) + cy3*m3*(c2*g - cx3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + cy3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - (-c3*td2 - s2*s3*td1)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) + (cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - cz3*m3*(cx3*(c2*tdd1 - s2*td1*td2 + tdd3) - cz3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 + (c2*td1 + td3)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) - (-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - d3*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - s3*(-Ixy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Iyz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) + cz4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) + (Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) - (c2*td1 + td3)*(-Ixy3*(c3*s2*td1 - s3*td2) + Iyy3*(-c3*td2 - s2*s3*td1) - Iyz3*(c2*td1 + td3)) + (-c3*td2 - s2*s3*td1)*(-Ixz3*(c3*s2*td1 - s3*td2) - Iyz3*(-c3*td2 - s2*s3*td1) + Izz3*(c2*td1 + td3)));

m21 = diff(a2,tdd1);
m22 = diff(a2,tdd2);
m23 = diff(a2,tdd3);
m24 = diff(a2,tdd4);
 
corio2=(td1*td1*diff(a2,td1,td1) + td1*td2*diff(a2,td1,td2) + td1*td3*diff(a2,td1,td3) + td1*td4*diff(a2,td1,td4)+...
        td2*td1*diff(a2,td2,td1) + td2*td2*diff(a2,td2,td2) + td2*td3*diff(a2,td2,td3) + td2*td4*diff(a2,td2,td4)+...
        td3*td1*diff(a2,td3,td1) + td3*td2*diff(a2,td3,td2) + td3*td3*diff(a2,td3,td3) + td3*td4*diff(a2,td3,td4)+...
        td4*td1*diff(a2,td4,td1) + td4*td2*diff(a2,td4,td2) + td4*td3*diff(a2,td4,td3) + td4*td4*diff(a2,td4,td4))/2;

ds_2g = diff(a2,g);
g2 =  ds_2g * g;

% Link 3

% str3="[-Ixz3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Iyz3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + Izz3*(c2*tdd1 - s2*td1*td2 + tdd3) - c3*(-Ixy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Iyz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) + cz4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) + (Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) + cx3*m3*(cx3*(c2*tdd1 - s2*td1*td2 + tdd3) - cz3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 + (c2*td1 + td3)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) - (-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - cy3*m3*(c3*g*s2 - cy3*(c2*tdd1 - s2*td1*td2 + tdd3) + cz3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - (c2*td1 + td3)*(cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2)) + (-c3*td2 - s2*s3*td1)*(-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))) - s3*(Ixx4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - Ixy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Ixz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cy4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - cz4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) - (-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) - (-c3*td2 - s2*s3*td1)*(Ixx3*(c3*s2*td1 - s3*td2) - Ixy3*(-c3*td2 - s2*s3*td1) - Ixz3*(c2*td1 + td3)) + (c3*s2*td1 - s3*td2)*(-Ixy3*(c3*s2*td1 - s3*td2) + Iyy3*(-c3*td2 - s2*s3*td1) - Iyz3*(c2*td1 + td3))]"
% newStr3 = replace(str3,"**2","^2")

a3 = -Ixz3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - Iyz3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) + Izz3*(c2*tdd1 - s2*td1*td2 + tdd3) - c3*(-Ixy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + Iyy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Iyz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cx4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) + cz4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) + (Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) + cx3*m3*(cx3*(c2*tdd1 - s2*td1*td2 + tdd3) - cz3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 + (c2*td1 + td3)*(-cy3*(c2*td1 + td3) + cz3*(-c3*td2 - s2*s3*td1)) - (-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))*(c3*s2*td1 - s3*td2)) - cy3*m3*(c3*g*s2 - cy3*(c2*tdd1 - s2*td1*td2 + tdd3) + cz3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2)) - (c2*td1 + td3)*(cx3*(c2*td1 + td3) - cz3*(c3*s2*td1 - s3*td2)) + (-c3*td2 - s2*s3*td1)*(-cx3*(-c3*td2 - s2*s3*td1) + cy3*(c3*s2*td1 - s3*td2))) - s3*(Ixx4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - Ixy4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - Ixz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cy4*m4*(-cx4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + cy4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + d3*(c2*td1 + td3)*(-c3*td2 - s2*s3*td1) - d3*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - g*s2*s3 - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))) - cz4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-Ixz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Iyz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + Izz4*(-c3*td2 - s2*s3*td1 + td4)) - (-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4))*(-c3*td2 - s2*s3*td1 + td4)) - (-c3*td2 - s2*s3*td1)*(Ixx3*(c3*s2*td1 - s3*td2) - Ixy3*(-c3*td2 - s2*s3*td1) - Ixz3*(c2*td1 + td3)) + (c3*s2*td1 - s3*td2)*(-Ixy3*(c3*s2*td1 - s3*td2) + Iyy3*(-c3*td2 - s2*s3*td1) - Iyz3*(c2*td1 + td3));

m31 = diff(a3,tdd1);
m32 = diff(a3,tdd2);
m33 = diff(a3,tdd3);
m34 = diff(a3,tdd4);

corio3=(td1*td1*diff(a3,td1,td1) + td1*td2*diff(a3,td1,td2) + td1*td3*diff(a3,td1,td3) + td1*td4*diff(a3,td1,td4)+...
        td2*td1*diff(a3,td2,td1) + td2*td2*diff(a3,td2,td2) + td2*td3*diff(a3,td2,td3) + td2*td4*diff(a3,td2,td4)+...
        td3*td1*diff(a3,td3,td1) + td3*td2*diff(a3,td3,td2) + td3*td3*diff(a3,td3,td3) + td3*td4*diff(a3,td3,td4)+...
        td4*td1*diff(a3,td4,td1) + td4*td2*diff(a3,td4,td2) + td4*td3*diff(a3,td4,td3) + td4*td4*diff(a3,td4,td4))/2;
    
ds_3g = diff(a3,g);
g3 =  ds_3g * g;

% Link 4
% str4="[-Ixz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - Iyz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + Izz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cx4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) - cy4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)**2 - d3*(c3*s2*td1 - s3*td2)**2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4)) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4))]"
% newStr4 = replace(str4,"**2","^2")

a4 = -Ixz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - Iyz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + Izz4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cx4*m4*(-c4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + cx4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) - cz4*(c4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - s4*(c2*tdd1 - s2*td1*td2 + tdd3) + td4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))) - s4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) + (-cy4*(-c3*td2 - s2*s3*td1 + td4) + cz4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)))*(-c3*td2 - s2*s3*td1 + td4)) - cy4*m4*(c4*(c3*g*s2 + d3*(c2*td1 + td3)*(c3*s2*td1 - s3*td2) + d3*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2))) - cy4*(-c3*tdd2 - s3*(c2*td1*td2 + s2*tdd1) - td3*(c3*s2*td1 - s3*td2) + tdd4) + cz4*(-c4*(c2*tdd1 - s2*td1*td2 + tdd3) - s4*(c3*(c2*td1*td2 + s2*tdd1) - s3*tdd2 + td3*(-c3*td2 - s2*s3*td1)) - td4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - s4*(c2*g - d3*(-c3*td2 - s2*s3*td1)^2 - d3*(c3*s2*td1 - s3*td2)^2) + (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(-cx4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) + cy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))) - (cx4*(-c3*td2 - s2*s3*td1 + td4) - cz4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)))*(-c3*td2 - s2*s3*td1 + td4)) - (-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2))*(Ixx4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) - Ixy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Ixz4*(-c3*td2 - s2*s3*td1 + td4)) + (c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3))*(-Ixy4*(c4*(c3*s2*td1 - s3*td2) - s4*(c2*td1 + td3)) + Iyy4*(-c4*(c2*td1 + td3) - s4*(c3*s2*td1 - s3*td2)) - Iyz4*(-c3*td2 - s2*s3*td1 + td4));

m41 = diff(a4,tdd1);
m42 = diff(a4,tdd2);
m43 = diff(a4,tdd3);
m44 = diff(a4,tdd4);

corio4=(td1*td1*diff(a4,td1,td1) + td1*td2*diff(a4,td1,td2) + td1*td3*diff(a4,td1,td3) + td1*td4*diff(a4,td1,td4)+...
        td2*td1*diff(a4,td2,td1) + td2*td2*diff(a4,td2,td2) + td2*td3*diff(a4,td2,td3) + td2*td4*diff(a4,td2,td4)+...
        td3*td1*diff(a4,td3,td1) + td3*td2*diff(a4,td3,td2) + td3*td3*diff(a4,td3,td3) + td3*td4*diff(a4,td3,td4)+...
        td4*td1*diff(a4,td4,td1) + td4*td2*diff(a4,td4,td2) + td4*td3*diff(a4,td4,td3) + td4*td4*diff(a4,td4,td4))/2;
    
ds_4g = diff(a4,g);
g4 =  ds_4g * g;

% matrix

% tau = M*tdd + V + G 
M = [m11 m12 m13 m14;
     m21 m22 m23 m24;
     m31 m32 m33 m34;
     m41 m42 m43 m44];

V = [corio1;
     corio2;
     corio3;
     corio4];
 
G = [g1;
     g2;
     g3;
     g4];
 
 %% Control of robot
% PID parameters:
% Kp = 10;
% Kd = 10;
% Ki = 1;